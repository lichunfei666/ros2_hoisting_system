# 前端与无人机节点、地面端的通讯逻辑与交互数据内容

## 1. 整体通信架构

在ROS2智能吊装系统中，前端通过WebSocket与ROS2系统通信，形成了一个完整的数据交互闭环：

```
前端界面 ←→ ROS2 WebSocket桥接器 ←→ 地面站节点 ←→ 无人机节点
```

### 1.1 通信中间件
- **WebSocket服务**：使用`rosbridge_server`提供的WebSocket服务，端口为9090
- **ROS2话题系统**：使用ROS2的发布/订阅机制进行数据传输
- **消息类型**：定义了多种自定义消息类型，如`SystemState`、`DroneCommand`等

## 2. 关键通信组件

### 2.1 前端通信模块

前端通过`roslib.js`库实现与ROS2系统的WebSocket连接：

```javascript
// 初始化ROS2 WebSocket连接
ros = new ROSLIB.Ros({
    url: 'ws://localhost:9090'
});

// 建立连接
ros.connect();

// 连接事件处理
ros.on('connection', function() {
    console.log('ROS连接已建立');
    addLogEntry('ROS2连接成功', 'success');
    updateSystemStatus('ROS连接正常', 'success');
});
```

### 2.2 地面站节点

地面站节点作为中间层，负责处理前端命令和无人机状态：

- **发布者**：发布系统状态、无人机命令等
- **订阅者**：订阅无人机状态、前端命令等
- **服务**：提供航点上传、执行控制等服务
- **异常检测**：检测无人机状态异常，触发紧急措施

### 2.3 无人机节点

无人机节点负责与DJI PSDK通信，执行飞行控制命令并反馈状态：

- **接收命令**：接收地面站发送的无人机控制命令
- **执行控制**：通过PSDK控制无人机的起飞、降落、移动等
- **反馈状态**：定期发布无人机的系统状态、电池信息、GPS数据等

## 3. 主要消息类型与数据结构

### 3.1 SystemState.msg - 系统状态消息

```msg
# System State Message
std_msgs/Header header

# System identification
string system_name

# Operational mode
string mode  # manual, auto, semi_auto, emergency
string status  # normal, warning, error, critical

# Power information
float64 battery_percentage  # Battery level in % (deprecated)
float64 battery_voltage  # Battery voltage in V (deprecated)
float64 battery_current  # Battery current in A (deprecated)

# Individual battery information
communication/BatteryInfo battery1  # Battery 1 information
communication/BatteryInfo battery2  # Battery 2 information

# Safety information
bool emergency_stop  # Emergency stop status
bool system_ready  # System ready status

# Error information
string error_message  # Error message if any
uint32 error_code  # Error code if any

# Performance metrics
float64 cpu_usage  # CPU usage in %
float64 memory_usage  # Memory usage in %
float64 system_temperature  # System temperature in °C
```

### 3.2 DroneCommand.msg - 无人机控制命令

```msg
# Drone Command Message
std_msgs/Header header

# Command type (enum)
uint8 COMMAND_TYPE_TAKEOFF = 0
uint8 COMMAND_TYPE_LAND = 1
uint8 COMMAND_TYPE_MOVE = 2
uint8 COMMAND_TYPE_HOVER = 3
uint8 COMMAND_TYPE_RETURN_HOME = 4
uint8 COMMAND_TYPE_SET_MODE = 5
uint8 COMMAND_TYPE_EMERGENCY_STOP = 6

uint8 command_type

# Position command parameters
float64 target_x  # Target X coordinate in meters (north)
float64 target_y  # Target Y coordinate in meters (east)
float64 target_z  # Target Z coordinate in meters (altitude)
float64 target_yaw  # Target yaw angle in radians
float64 speed  # Movement speed in m/s

# Mode command parameters
string flight_mode  # Flight mode (manual, gps_atti, gps_pos, etc.)

# Emergency parameters
bool emergency_stop  # Emergency stop flag

# Takeoff/Land parameters
float64 takeoff_height  # Takeoff height in meters
float64 landing_speed  # Landing speed in m/s
```

### 3.3 MissionCommand.msg - 任务命令

```msg
# Mission Command Message
std_msgs/Header header

# Mission type (enum)
uint8 MISSION_TYPE_TAKE_OFF = 0
uint8 MISSION_TYPE_LAND = 1
uint8 MISSION_TYPE_MOVE_TO = 2
uint8 MISSION_TYPE_FOLLOW_PATH = 3
uint8 MISSION_TYPE_HOVER = 4
uint8 MISSION_TYPE_RETURN_HOME = 5
uint8 MISSION_TYPE_CUSTOM = 6

uint8 mission_type
string mission_name  # Mission name for identification

# Mission parameters
float64 target_x  # Target X coordinate in meters
float64 target_y  # Target Y coordinate in meters
float64 target_z  # Target Z coordinate in meters
float64 target_yaw  # Target yaw angle in radians
float64 speed  # Mission speed in m/s

# Mission flags
bool start_mission  # Start the mission
bool pause_mission  # Pause the mission
bool cancel_mission  # Cancel the mission
bool emergency_stop  # Emergency stop flag

# Mission configuration
float64 mission_timeout  # Mission timeout in seconds
bool mission_repeat  # Repeat mission after completion
bool mission_preemptible  # Mission can be preempted by higher priority missions
```

### 3.4 PSDKCmd.msg - PSDK相关命令

```msg
# PSDK Command Message
std_msgs/Header header

# Command type (enum)
uint8 CMD_TYPE_TAKEOFF = 0
uint8 CMD_TYPE_LAND = 1
uint8 CMD_TYPE_MOVE = 2
uint8 CMD_TYPE_HOVER = 3
uint8 CMD_TYPE_RETURN_HOME = 4
uint8 CMD_TYPE_HOOK_CONTROL = 5
uint8 CMD_TYPE_EMERGENCY_STOP = 6
uint8 CMD_TYPE_WAYPOINT_V3_UPLOAD = 7
uint8 CMD_TYPE_WAYPOINT_V3_START = 8
uint8 CMD_TYPE_WAYPOINT_V3_STOP = 9
uint8 CMD_TYPE_WAYPOINT_V3_PAUSE = 10
uint8 CMD_TYPE_WAYPOINT_V3_RESUME = 11

uint8 command_type

# Waypoint V3 parameters (for WAYPOINT_V3 commands)
string waypoint_file_path  # Path to the waypoint V3 kmz file

# Common command parameters
bool emergency  # Emergency command flag
float64 timeout  # Command timeout in seconds

# Position command parameters (for MOVE command)
float64 target_x  # Target X position in meters (north)
float64 target_y  # Target Y position in meters (east)
float64 target_z  # Target Z position in meters (altitude)
float64 target_yaw  # Target yaw angle in radians
float64 movement_speed  # Movement speed in m/s

# Hook control parameters (for HOOK_CONTROL command)
uint8 HOOK_ACTION_OPEN = 0
uint8 HOOK_ACTION_CLOSE = 1
uint8 HOOK_ACTION_RELEASE = 2

uint8 hook_action
float64 hook_force  # Hook force in N (if supported)
float64 hook_duration  # Hook action duration in seconds (if supported)
bool emergency_release  # Emergency release flag

# Takeoff/Land parameters
float64 takeoff_height  # Takeoff height in meters
float64 landing_speed  # Landing speed in m/s
```

### 3.5 PSDKData.msg - PSDK数据

```msg
# PSDK Data Message
std_msgs/Header header

# System state
bool system_ready
bool is_flying
string flight_mode  # manual, assisted_takeoff, gps_atti, gps_vel, gps_pos, altitude_hold, hotpoint, waypoint, follow_me, auto_landing, motor_off
uint8 flight_stage  # 0: Unknown, 1: Ready to take off, 2: Taking off, 3: In flight, 4: Landing, 5: Landed

# GPS data
bool gps_valid
float64 latitude  # degrees
float64 longitude  # degrees
float64 altitude  # meters above sea level
float64 height_above_ground  # meters above ground
uint8 num_satellites

# IMU data (angular velocities)
float64 imu_angular_velocity_x  # rad/s
float64 imu_angular_velocity_y  # rad/s
float64 imu_angular_velocity_z  # rad/s

# IMU data (linear accelerations)
float64 imu_linear_acceleration_x  # m/s^2
float64 imu_linear_acceleration_y  # m/s^2
float64 imu_linear_acceleration_z  # m/s^2

# Attitude data
float64 roll  # radians
float64 pitch  # radians
float64 yaw  # radians

# Velocity data
float64 velocity_x  # m/s (north)
float64 velocity_y  # m/s (east)
float64 velocity_z  # m/s (down)

# Battery information
float64 battery_voltage  # V
float64 battery_percentage  # 0-100%
float64 remaining_flight_time  # minutes

# Connection status
float64 signal_quality  # 0-1
uint8 connection_type  # 0: USB, 1: WiFi, 2: Serial

# Error information
string error_message
uint32 error_code
```

## 4. 通信流程详解

### 4.1 前端订阅状态信息

前端订阅无人机状态和系统状态话题，实时更新界面显示：

```javascript
// 订阅无人机状态话题
droneStateSub = new ROSLIB.Topic({
    ros: ros,
    name: '/drone/system_state',
    messageType: 'communication/msg/SystemState'
});

droneStateSub.subscribe(function(msg) {
    // 更新无人机模式
    document.getElementById('drone-mode').textContent = msg.mode;
    
    // 更新电池电量显示
    document.getElementById('drone-battery').style.width = `${msg.battery_percentage}%`;
    document.getElementById('drone-battery-percent').textContent = `${msg.battery_percentage}%`;
    
    // 更新其他状态信息...
});
```

### 4.2 前端发布控制命令

前端通过按钮点击等交互发布控制命令：

```javascript
// 起飞按钮事件处理
startMissionBtn.addEventListener('click', () => {
    // 发布任务开始命令
    const msg = new ROSLIB.Message({
        command: 'start',
        mission_type: '',
        timestamp: Date.now()
    });
    missionCmdPub.publish(msg);
});

// 无人机控制命令发布
const droneCmdPub = new ROSLIB.Topic({
    ros: ros,
    name: '/drone/command',
    messageType: 'communication/msg/DroneCommand'
});

function sendTakeoffCommand() {
    const takeoffMsg = new ROSLIB.Message({
        command_type: 0,  // COMMAND_TYPE_TAKEOFF
        takeoff_height: 10.0,
        emergency_stop: false
    });
    droneCmdPub.publish(takeoffMsg);
}
```

### 4.3 地面站节点处理命令

地面站节点订阅前端命令并转发给无人机节点：

```cpp
// 无人机命令回调函数
void drone_command_callback(const communication::msg::DroneCommand::SharedPtr msg)
{
    // 将数字命令类型转换为中文描述以提高日志可读性
    std::string command_desc;
    switch(msg->command_type) {
        case communication::msg::DroneCommand::COMMAND_TYPE_TAKEOFF: command_desc = "起飞";
            break;
        case communication::msg::DroneCommand::COMMAND_TYPE_LAND: command_desc = "降落";
            break;
        // 其他命令类型...
    }
    
    CUSTOM_LOG_INFO(this, "接收到前端无人机控制命令: %s", command_desc.c_str());
    
    // 转发命令给无人机节点
    drone_command_pub_->publish(*msg);
}
```

### 4.4 无人机节点执行命令并反馈

无人机节点通过PSDK执行命令并定期发布状态：

```cpp
// 无人机命令订阅回调
void drone_command_callback(const communication::msg::DroneCommand::SharedPtr msg)
{
    // 根据命令类型执行不同操作
    switch(msg->command_type) {
        case communication::msg::DroneCommand::COMMAND_TYPE_TAKEOFF:
            // 执行起飞操作
            takeoff();
            break;
        case communication::msg::DroneCommand::COMMAND_TYPE_LAND:
            // 执行降落操作
            land();
            break;
        // 其他命令处理...
    }
}

// 定期发布无人机状态
void publish_system_state()
{
    auto state_msg = communication::msg::SystemState();
    state_msg.header.stamp = this->get_clock()->now();
    
    // 填充无人机状态信息
    state_msg.system_name = "DJI Drone";
    state_msg.mode = current_flight_mode;
    state_msg.status = system_status;
    state_msg.battery_percentage = battery_info.percentage;
    
    // 发布状态消息
    system_state_pub_->publish(state_msg);
}
```

### 4.5 异常检测与紧急处理

地面站节点实现了异常检测逻辑，当检测到异常时触发紧急措施：

```cpp
// 异常检测函数
void check_for_anomalies()
{
    // 如果已经触发紧急停止，不再重复处理
    if (emergency_stop_triggered_) {
        return;
    }
    
    // 检测无人机连接状态
    if (enable_connection_check_ && (latest_drone_state_.mode == "disconnected" || latest_drone_state_.status == "disconnected")) {
        trigger_emergency_action();
    }
    
    // 检测电池电量
    else if (latest_drone_state_.battery1.percentage < min_battery_percentage_ || 
             latest_drone_state_.battery2.percentage < min_battery_percentage_) {
        trigger_emergency_action();
    }
    
    // 检测系统状态
    else if (latest_drone_state_.status == "error" || latest_drone_state_.status == "critical") {
        trigger_emergency_action();
    }
    
    // 检测紧急停止状态
    else if (latest_drone_state_.emergency_stop) {
        trigger_emergency_action();
    }
}

// 触发应急措施
void trigger_emergency_action()
{
    emergency_stop_triggered_ = true;
    
    // 发送紧急停飞命令
    auto emergency_cmd = communication::msg::DroneCommand();
    emergency_cmd.header.stamp = this->get_clock()->now();
    emergency_cmd.command_type = communication::msg::DroneCommand::COMMAND_TYPE_EMERGENCY_STOP;
    emergency_cmd.emergency_stop = true;
    
    drone_command_pub_->publish(emergency_cmd);
    
    // 更新系统状态
    system_state_.emergency_stop = true;
    system_state_.status = "critical";
    system_state_.error_message = "已触发地面站紧急停飞";
}
```

## 5. 交互数据内容

### 5.1 前端接收的数据

前端主要接收以下类型的数据：

| 数据类型 | 来源 | 话题名称 | 主要内容 |
|---------|------|---------|---------|
| 系统状态 | 地面站节点 | /system_state | 系统名称、模式、状态、紧急停止状态 |
| 无人机状态 | 无人机节点 | /drone/system_state | 飞行模式、电池电量、GPS信息、姿态数据 |
| PSDK数据 | 无人机节点 | /drone/psdk_data | 飞行状态、GPS坐标、速度、剩余飞行时间 |
| 任务状态 | 地面站节点 | /mission/status | 任务阶段、进度、状态 |
| 挂钩数据 | 挂钩控制器 | /hoist/data | 挂钩状态、高度、速度、负载信息 |

### 5.2 前端发送的数据

前端主要发送以下类型的命令：

| 命令类型 | 目标 | 话题名称 | 主要内容 |
|---------|------|---------|---------|
| 无人机控制命令 | 地面站节点 | /drone/command | 起飞、降落、移动、悬停、返航、紧急停止 |
| 任务命令 | 地面站节点 | /mission/cmd | 任务开始、暂停、取消、紧急停止 |
| PSDK命令 | 无人机节点 | /drone/psdk_cmd | 航点上传、开始、停止、暂停、恢复 |
| 挂钩控制命令 | 挂钩控制器 | /hoist/cmd | 挂钩打开、关闭、释放、锁定 |

## 6. 通信安全与可靠性

### 6.1 数据有效性验证

在各个节点中，都实现了数据有效性验证机制：

```cpp
// 电池信息验证
if (battery_info.voltage <= 0 || battery_info.percentage > 100) {
    // 数据无效，使用默认值或上一次有效数据
    battery_info.percentage = 100.0;
    battery_info.voltage = 25.0;
}
```

### 6.2 异常处理

通信过程中实现了完善的异常处理机制：

```javascript
// 前端ROS连接错误处理
ros.on('error', function(error) {
    console.error('ROS连接错误:', error);
    const errorMsg = error.code ? `${error.code} - ${error.message || '未知错误'}` : error;
    addLogEntry(`ROS2连接错误: ${errorMsg}`, 'danger');
    updateSystemStatus('ROS连接错误', 'danger');
});

// 连接关闭处理
ros.on('close', function() {
    console.log('ROS连接已关闭');
    addLogEntry('ROS2连接关闭', 'warning');
    updateSystemStatus('ROS连接关闭', 'warning');
});
```

### 6.3 紧急停止机制

系统实现了多层级的紧急停止机制：

1. **前端紧急停止按钮**：用户可直接点击触发
2. **地面站自动紧急停止**：检测到异常时自动触发
3. **无人机硬件紧急停止**：PSDK层面的紧急停止机制

## 7. 总结

本系统采用了基于ROS2的分布式通信架构，通过WebSocket实现了前端与后端的实时数据交互。主要特点包括：

1. **模块化设计**：各个功能模块通过话题通信，耦合度低
2. **实时性**：使用WebSocket和ROS2的实时通信机制，确保数据传输的及时性
3. **可靠性**：实现了数据验证、异常处理和多层级紧急停止机制
4. **可扩展性**：新的功能模块可以通过定义新的消息类型和话题进行扩展

这种通信架构为ROS2智能吊装系统提供了稳定、高效的数据交互基础，支持了复杂的无人机控制和任务执行功能。