# 地面站节点工作流程与数据交互说明

## 1. 地面站节点概述

地面站节点（GroundStationNode）是ROS2智能吊装系统的核心控制节点，负责协调前端界面、无人机节点和其他系统组件之间的通信。它接收来自前端的控制命令，转发给无人机节点，并监控无人机状态，进行异常检测和应急处理。

## 2. 节点结构与工作流程

### 2.1 节点初始化流程

1. **节点创建**：通过`main`函数初始化ROS2环境并创建`GroundStationNode`实例
2. **参数配置**：从ROS2参数服务器获取配置参数（最低电池阈值、卫星数量等）
3. **组件初始化**：
   - 创建发布者（系统状态、无人机命令、PSDK命令）
   - 创建服务（航线上传、开始、停止、暂停、恢复、检验）
   - 创建订阅者（无人机状态、前端控制命令、任务命令）
   - 创建定时器（定期发布系统状态）
4. **启动完成**：记录日志并开始监听命令

### 2.2 核心工作流程

1. **状态监控**：定期接收无人机状态，进行异常检测
2. **命令转发**：接收前端控制命令，转发给无人机节点
3. **服务处理**：响应航线上传、开始等服务请求
4. **异常处理**：检测到异常时触发应急措施
5. **状态发布**：定期发布系统状态信息

## 3. 函数接口解析

### 3.1 核心类定义

```cpp
class GroundStationNode : public rclcpp::Node
{
private:
    // 发布者
    rclcpp::Publisher<communication::msg::SystemState>::SharedPtr system_state_pub_;
    rclcpp::Publisher<communication::msg::DroneCommand>::SharedPtr drone_command_pub_;
    rclcpp::Publisher<communication::msg::PSDKCmd>::SharedPtr psdk_cmd_pub_;
    
    // 服务
    rclcpp::Service<std_srvs::srv::Trigger>::SharedPtr upload_waypoint_srv_;
    rclcpp::Service<std_srvs::srv::Trigger>::SharedPtr start_waypoint_srv_;
    rclcpp::Service<std_srvs::srv::Trigger>::SharedPtr stop_waypoint_srv_;
    rclcpp::Service<std_srvs::srv::Trigger>::SharedPtr pause_waypoint_srv_;
    rclcpp::Service<std_srvs::srv::Trigger>::SharedPtr resume_waypoint_srv_;
    rclcpp::Service<std_srvs::srv::Trigger>::SharedPtr verify_waypoint_srv_;
    
    // 订阅者
    rclcpp::Subscription<communication::msg::SystemState>::SharedPtr drone_state_sub_;
    rclcpp::Subscription<communication::msg::MissionCommand>::SharedPtr mission_cmd_sub_;
    rclcpp::Subscription<communication::msg::DroneCommand>::SharedPtr drone_command_sub_;
    
    // 定时器
    rclcpp::TimerBase::SharedPtr timer_;
    
    // 系统状态
    communication::msg::SystemState system_state_;
    communication::msg::SystemState latest_drone_state_;
    
    // 异常检测标志
    bool emergency_stop_triggered_;
    rclcpp::Time last_emergency_time_;
    
    // 配置参数
    double min_battery_percentage_;
    int min_satellite_count_;
    bool enable_auto_emergency_;
    bool enable_connection_check_;
    
    // 核心回调函数
    void drone_state_callback(const communication::msg::SystemState::SharedPtr msg);
    void check_for_anomalies();
    void trigger_emergency_action();
    void drone_command_callback(const communication::msg::DroneCommand::SharedPtr msg);
    void mission_command_callback(const communication::msg::MissionCommand::SharedPtr msg);
    void clear_emergency_state();
    void timer_callback();
    
    // 服务回调函数
    void upload_waypoint_v3_callback(const std::shared_ptr<std_srvs::srv::Trigger::Request> request, 
                                     std::shared_ptr<std_srvs::srv::Trigger::Response> response);
    void verify_waypoint_v3_callback(const std::shared_ptr<std_srvs::srv::Trigger::Request> request, 
                                    std::shared_ptr<std_srvs::srv::Trigger::Response> response);
    void start_waypoint_v3_callback(const std::shared_ptr<std_srvs::srv::Trigger::Request> request, 
                                   std::shared_ptr<std_srvs::srv::Trigger::Response> response);
    void stop_waypoint_v3_callback(const std::shared_ptr<std_srvs::srv::Trigger::Request> request, 
                                  std::shared_ptr<std_srvs::srv::Trigger::Response> response);
    void pause_waypoint_v3_callback(const std::shared_ptr<std_srvs::srv::Trigger::Request> request, 
                                   std::shared_ptr<std_srvs::srv::Trigger::Response> response);
    void resume_waypoint_v3_callback(const std::shared_ptr<std_srvs::srv::Trigger::Request> request, 
                                    std::shared_ptr<std_srvs::srv::Trigger::Response> response);
    
public:
    GroundStationNode();
    ~GroundStationNode();
};
```

### 3.2 核心函数解析

#### 3.2.1 无人机状态回调函数

```cpp
void drone_state_callback(const communication::msg::SystemState::SharedPtr msg)
{
    // 保存最新的无人机状态
    latest_drone_state_ = *msg;
    
    // 检测异常
    check_for_anomalies();
}
```

**功能**：接收无人机状态消息，保存最新状态并触发异常检测。

**参数**：
- `msg`：无人机状态消息指针，包含无人机的电池电量、连接状态、系统状态等信息。

**返回值**：无

#### 3.2.2 异常检测函数

```cpp
void check_for_anomalies()
{
    // 如果已经触发紧急停止，不再重复处理
    if (emergency_stop_triggered_) {
        return;
    }
    
    // 检查无人机状态消息是否有效
    if (latest_drone_state_.system_name.empty()) {
        return;
    }
    
    std::string error_message = "";
    bool anomaly_detected = false;
    
    // 检测无人机连接状态
    if (enable_connection_check_ && (latest_drone_state_.mode == "disconnected" || latest_drone_state_.status == "disconnected")) {
        error_message = "无人机连接断开";
        anomaly_detected = true;
    }
    
    // 检测电池电量
    else if (latest_drone_state_.battery1.percentage < min_battery_percentage_ || 
             latest_drone_state_.battery2.percentage < min_battery_percentage_) {
        error_message = "电池电量过低: " + std::to_string(latest_drone_state_.battery1.percentage) + "% / " + std::to_string(latest_drone_state_.battery2.percentage) + "%";
        anomaly_detected = true;
    }
    
    // 检测系统状态
    else if (latest_drone_state_.status == "error" || latest_drone_state_.status == "critical") {
        error_message = "无人机系统错误: " + latest_drone_state_.error_message;
        anomaly_detected = true;
    }
    
    // 检测紧急停止状态
    else if (latest_drone_state_.emergency_stop) {
        error_message = "无人机触发了紧急停止";
        anomaly_detected = true;
    }
    
    // 如果检测到异常
    if (anomaly_detected) {
        // 更新系统状态
        system_state_.status = "critical";
        system_state_.error_message = error_message;
        
        // 触发应急措施
        if (enable_auto_emergency_) {
            trigger_emergency_action();
        }
    }
}
```

**功能**：检测无人机状态中的异常情况，如连接断开、低电量、系统错误等。

**参数**：无

**返回值**：无

**异常检测类型**：
- 无人机连接断开
- 电池电量过低
- 系统错误
- 紧急停止状态

#### 3.2.3 无人机命令回调函数

```cpp
void drone_command_callback(const communication::msg::DroneCommand::SharedPtr msg)
{
    // 将数字命令类型转换为中文描述以提高日志可读性
    std::string command_desc;
    switch(msg->command_type) {
        case communication::msg::DroneCommand::COMMAND_TYPE_TAKEOFF: command_desc = "起飞";
            break;
        case communication::msg::DroneCommand::COMMAND_TYPE_LAND: command_desc = "降落";
            break;
        case communication::msg::DroneCommand::COMMAND_TYPE_MOVE: command_desc = "移动";
            break;
        case communication::msg::DroneCommand::COMMAND_TYPE_HOVER: command_desc = "悬停";
            break;
        case communication::msg::DroneCommand::COMMAND_TYPE_RETURN_HOME: command_desc = "返航";
            break;
        case communication::msg::DroneCommand::COMMAND_TYPE_SET_MODE: command_desc = "设置模式";
            break;
        case communication::msg::DroneCommand::COMMAND_TYPE_EMERGENCY_STOP: command_desc = "紧急停止";
            break;
        default: command_desc = "未知命令 (" + std::to_string(msg->command_type) + ")";
    }
    
    CUSTOM_LOG_INFO(this, "接收到前端无人机控制命令: %s", command_desc.c_str());
    
    // 转发命令给无人机节点
    drone_command_pub_->publish(*msg);
}
```

**功能**：接收前端控制命令并转发给无人机节点。

**参数**：
- `msg`：无人机控制命令消息指针，包含命令类型、参数等信息。

**支持的命令类型**：
- 起飞
- 降落
- 移动
- 悬停
- 返航
- 设置模式
- 紧急停止

**返回值**：无

#### 3.2.4 任务命令回调函数

```cpp
void mission_command_callback(const communication::msg::MissionCommand::SharedPtr msg)
{
    // 处理紧急停止命令
    if (msg->emergency_stop) {
        CUSTOM_LOG_ERROR(this, "收到紧急停止命令，触发应急措施");
        trigger_emergency_action();
    }
}
```

**功能**：接收任务命令，处理紧急停止命令。

**参数**：
- `msg`：任务命令消息指针，包含紧急停止标志等信息。

**返回值**：无

#### 3.2.5 定时器回调函数

```cpp
void timer_callback()
{
    auto header = std_msgs::msg::Header();
    header.stamp = this->get_clock()->now();
    header.frame_id = "ground_station";

    system_state_.header = header;
    system_state_.system_name = "Hoisting System";
    system_state_.mode = "manual";
    
    // 更新紧急停止状态
    system_state_.emergency_stop = emergency_stop_triggered_;
    
    // 如果没有检测到异常，保持正常状态
    if (!emergency_stop_triggered_ && system_state_.status != "error" && system_state_.status != "critical") {
        system_state_.status = "normal";
    }

    system_state_pub_->publish(system_state_);
    
    // 定期检查紧急状态，如果超过一定时间自动解除
    if (emergency_stop_triggered_) {
        auto now = this->get_clock()->now();
        auto duration = now - last_emergency_time_;
        if (duration > 5s) {
            CUSTOM_LOG_WARN(this, "紧急状态已持续超过5秒，自动解除");
            clear_emergency_state();
        }
    }
}
```

**功能**：定期发布系统状态信息，检查并自动解除紧急状态。

**参数**：无

**返回值**：无

**发布的系统状态内容**：
- 系统名称
- 工作模式
- 系统状态（正常、错误、紧急）
- 紧急停止状态
- 错误信息

#### 3.2.6 服务回调函数

**航线上传服务回调**

```cpp
void upload_waypoint_v3_callback(const std::shared_ptr<std_srvs::srv::Trigger::Request> request, 
                                 std::shared_ptr<std_srvs::srv::Trigger::Response> response)
{
    // 上传航线文件
    auto upload_cmd = communication::msg::PSDKCmd();
    upload_cmd.header.stamp = this->get_clock()->now();
    upload_cmd.command_type = communication::msg::PSDKCmd::CMD_TYPE_WAYPOINT_V3_UPLOAD;
    upload_cmd.waypoint_file_path = "src/ground_station/config/waypoint_v3_test_file.kmz";
    
    psdk_cmd_pub_->publish(upload_cmd);
    
    response->success = true;
    response->message = "Waypoint V3 航线文件上传成功";
}
```

**功能**：处理航线上传服务请求，向无人机节点发送航线上传命令。

**参数**：
- `request`：服务请求指针
- `response`：服务响应指针，包含操作结果和消息

**返回值**：无

**其他服务回调函数**（类似的实现方式）：
- `verify_waypoint_v3_callback`：航线执行检验服务回调
- `start_waypoint_v3_callback`：航线任务开始服务回调
- `stop_waypoint_v3_callback`：航线任务停止服务回调
- `pause_waypoint_v3_callback`：航线任务暂停服务回调
- `resume_waypoint_v3_callback`：航线任务恢复服务回调

## 4. 数据交互

### 4.1 与前端的通信

**数据流向**：
- 前端 → 地面站节点：无人机控制命令（起飞、降落、悬停等）
- 地面站节点 → 前端：系统状态信息（模式、状态、错误信息等）

**通信方式**：WebSocket

**WebSocket地址**：`ws://localhost:9090`

**消息类型**：
- 控制命令：`DroneCommand`
- 系统状态：`SystemState`

### 4.2 与无人机节点的通信

**数据流向**：
- 无人机节点 → 地面站节点：无人机状态信息（位置、速度、电池电量等）
- 地面站节点 → 无人机节点：无人机控制命令（起飞、降落、悬停等）

**通信方式**：ROS2话题

**话题名称**：
- 无人机状态：`/drone/system_state`
- 无人机命令：`/drone/command`
- PSDK命令：`/drone/psdk_cmd`

**消息类型**：
- 无人机状态：`SystemState`
- 无人机命令：`DroneCommand`
- PSDK命令：`PSDKCmd`

### 4.3 与其他节点的通信

**数据流向**：
- 其他节点 → 地面站节点：任务命令（紧急停止等）
- 地面站节点 → 其他节点：系统状态信息（模式、状态、错误信息等）

**通信方式**：ROS2话题和服务

**话题名称**：
- 任务命令：`/mission/cmd`
- 系统状态：`/system_state`

**服务名称**：
- 航线上传：`/ground_station/upload_waypoint_v3`
- 航线开始：`/ground_station/start_waypoint_v3`
- 航线停止：`/ground_station/stop_waypoint_v3`
- 航线暂停：`/ground_station/pause_waypoint_v3`
- 航线恢复：`/ground_station/resume_waypoint_v3`
- 航线检验：`/ground_station/verify_waypoint_v3`

**消息类型**：
- 任务命令：`MissionCommand`
- 系统状态：`SystemState`
- 服务请求/响应：`Trigger`

## 5. 异常处理机制

### 5.1 异常检测

地面站节点定期检测以下异常情况：

1. **无人机连接断开**：检测无人机状态是否为"disconnected"
2. **电池电量过低**：检测电池1或电池2的电量是否低于设定阈值
3. **系统错误**：检测无人机状态是否为"error"或"critical"
4. **紧急停止状态**：检测无人机是否触发了紧急停止

### 5.2 应急措施

当检测到异常时，地面站节点会采取以下应急措施：

1. **发送紧急停止命令**：向无人机节点发送紧急停止命令
2. **更新系统状态**：将系统状态设置为"critical"，并记录错误信息
3. **自动解除**：紧急状态持续超过5秒后自动解除

### 5.3 手动解除

用户可以通过前端界面或服务请求手动解除紧急状态：

1. **发送解除命令**：向无人机节点发送解除紧急停止命令
2. **更新系统状态**：将系统状态设置为"normal"，清除错误信息

## 6. 配置参数

地面站节点支持以下配置参数：

| 参数名称 | 类型 | 默认值 | 说明 |
|---------|------|-------|------|
| min_battery_percentage | double | 20.0 | 最低电池电量阈值（%） |
| min_satellite_count | int | 8 | 最低卫星数量 |
| enable_auto_emergency | bool | false | 是否启用自动应急措施 |
| enable_connection_check | bool | false | 是否启用无人机连接检测 |

这些参数可以通过ROS2参数服务器进行配置，例如：

```bash
ros2 run ground_station ground_station_node --ros-args -p min_battery_percentage:=25.0 -p enable_auto_emergency:=true
```

## 7. 总结

地面站节点是ROS2智能吊装系统的核心控制节点，负责协调前端界面、无人机节点和其他系统组件之间的通信。它接收来自前端的控制命令，转发给无人机节点，并监控无人机状态，进行异常检测和应急处理。

地面站节点的主要功能包括：

1. 接收并转发前端控制命令
2. 接收并处理无人机状态信息
3. 检测异常情况并触发应急措施
4. 提供航线上传、开始等服务
5. 定期发布系统状态信息

通过这些功能，地面站节点实现了对无人机的远程控制和监控，确保了系统的安全和稳定运行。